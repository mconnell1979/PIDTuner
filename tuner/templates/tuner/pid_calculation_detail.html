{% extends "core/base.html" %}

{% block title %}PID Calculation Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">PID Calculation Details</h2>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">PID Loop: {{ pid_calculation.pid_loop.name }}</h5>
        </div>
        <div class="card-body">
            <p class="small"><strong>PID Type:</strong> {{ pid_calculation.pid_loop.pid_type }}</p>

            {% if pid_calculation.pid_loop.selected_pid_calculation == pid_calculation %}
                <span class="badge bg-success small">Selected for PID Loop</span>
            {% endif %}

            <h6 class="mt-3">Select Tuning Method</h6>
            <select class="form-select form-select-sm w-25" id="tuning_method">
                <option value="lambda" selected>Lambda Tuning</option>
                <option value="cohen">Cohen-Coon Tuning</option>
            </select>

            <h6 class="mt-3">Bump Tests Used</h6>
            <form id="bump_test_form">
                <table class="table table-sm table-striped table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center align-middle" style="width: 5%;">✔</th>
                            <th class="text-center align-middle" style="width: 5%;">ID</th>
                            <th class="text-center align-middle">Date</th>
                            <th class="text-center align-middle">Start Time</th>
                            <th class="text-center align-middle">End Time</th>
                            <th class="text-center">P</th>
                            <th class="text-center">I</th>
                            <th class="text-center">D</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bump in available_bump_tests %}
                            <tr>
                                <td class="text-center align-middle">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <input type="checkbox" name="bump_tests" value="{{ bump.id }}"
                                            id="bump{{ bump.id }}" class="form-check-input"
                                            {% if bump in assigned_bump_tests %}checked{% endif %}>
                                    </div>
                                </td>
                                <td class="text-center align-middle">
                                    <a href="{% url 'tuner:identity_trend_detail' bump.trend_chart.id bump.id %}" class="text-decoration-none">
                                        {{ bump.id }}
                                    </a>
                                </td>
                                <td class="text-center align-middle">{{ bump.T1|date:"Y-m-d" }}</td>
                                <td class="text-center align-middle">{{ bump.T1|date:"H:i:s" }}</td>
                                <td class="text-center align-middle">{{ bump.T2|date:"H:i:s" }}</td>
                                <td class="small text-center align-middle pid-lambda">{{ bump.p|default:"-" }}</td>
                                <td class="small text-center align-middle pid-lambda">{{ bump.i|default:"-" }}</td>
                                <td class="small text-center align-middle pid-lambda">{{ bump.d|default:"-" }}</td>
                                <td class="small text-center align-middle pid-cohen d-none">{{ bump.p_cohen|default:"-" }}</td>
                                <td class="small text-center align-middle pid-cohen d-none">{{ bump.i_cohen|default:"-" }}</td>
                                <td class="small text-center align-middle pid-cohen d-none">{{ bump.d_cohen|default:"-" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <button type="button" class="btn btn-secondary btn-sm mt-2" id="update_bumps">
                    <i class="fas fa-sync-alt"></i> Update Bump Selection
                </button>
            </form>

            <!-- ✅ Lambda Value & Slider (Hidden unless Lambda is selected) -->
            <div id="lambda_section">
                <h6 class="mt-4">Lambda Tuning</h6>
                <form id="lambda_form">
                    <div class="mb-2">
                        <label for="lambda_value" class="small"><strong>Lambda Value:</strong></label>
                        <div class="d-flex align-items-center">
                            <input type="number" step="0.01" class="form-control form-control-sm w-25 me-2 text-center"
                                   id="lambda_value" name="lambda_value"
                                   value="{{ pid_calculation.lambda_value }}"
                                   min="{{ pid_calculation.min_lambda }}"
                                   max="{{ pid_calculation.max_lambda }}">
                            <span class="text-muted small">(seconds)</span>
                        </div>
                    </div>
                    <input type="range" class="form-range" id="lambda_slider"
                           min="{{ pid_calculation.min_lambda }}"
                           max="{{ pid_calculation.max_lambda }}"
                           step="0.01" value="{{ pid_calculation.lambda_value }}">
                </form>
            </div>

            <h6 class="mt-4">PID Tuning Results</h6>
            <table class="table table-sm table-bordered">
                <tbody>
                    <tr>
                        <th class="small">Proportional Gain (Kp)</th>
                        <td class="small text-center pid-lambda">{{ pid_calculation.proportional_gain }}</td>
                        <td class="small text-center pid-cohen d-none">{{ pid_calculation.p_cohen }}</td>
                        <td class="text-muted small">(%CV / %PV)</td>
                    </tr>
                    <tr>
                        <th class="small">Integral Time (Ti)</th>
                        <td class="small text-center pid-lambda">{{ pid_calculation.integral_time }}</td>
                        <td class="small text-center pid-cohen d-none">{{ pid_calculation.i_cohen }}</td>
                        <td class="text-muted small">(seconds)</td>
                    </tr>
                    <tr>
                        <th class="small">Derivative Time (Td)</th>
                        <td class="small text-center pid-lambda">{{ pid_calculation.derivative_time }}</td>
                        <td class="small text-center pid-cohen d-none">{{ pid_calculation.d_cohen }}</td>
                        <td class="text-muted small">(seconds)</td>
                    </tr>
                </tbody>
            </table>

            <button class="btn btn-info btn-sm mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#pidGraphCollapse" aria-expanded="false" aria-controls="pidGraphCollapse">
                <i class="fas fa-chart-line"></i> Show/Hide PID Graph
            </button>
            <div class="collapse mt-3" id="pidGraphCollapse">
                <canvas id="pidChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let tuningMethodDropdown = document.getElementById("tuning_method");

    tuningMethodDropdown.addEventListener("change", function () {
        let selectedMethod = this.value;
        let lambdaFields = document.querySelectorAll(".pid-lambda");
        let cohenFields = document.querySelectorAll(".pid-cohen");
        let lambdaSection = document.getElementById("lambda_section");

        if (selectedMethod === "lambda") {
            lambdaFields.forEach(el => el.classList.remove("d-none"));
            cohenFields.forEach(el => el.classList.add("d-none"));
            lambdaSection.style.display = "block";
        } else {
            lambdaFields.forEach(el => el.classList.add("d-none"));
            cohenFields.forEach(el => el.classList.remove("d-none"));
            lambdaSection.style.display = "none";
        }
    });
});
</script>

{% endblock %}
