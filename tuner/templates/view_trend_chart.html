{% extends "base.html" %}

{% block content %}
    <h1>Identity Trend Detail</h1>

    <div id="identityTrendChart" style="width: 100%; height: 500px;"></div>

    <button id="saveBump" style="margin-top: 10px;">Save Bump</button>

    <!-- Display all bump tests -->
    <h2>Bump Tests</h2>
    <table border="1" style="width: 100%; margin-top: 20px; text-align: center;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="bumpList">
            {% if bump_tests %}
                {% for bump in bump_tests %}
                <tr id="bumpRow-{{ bump.id }}">
                    <td>
                        <a href="#" onclick="zoomToBump({{ bump.id }}, '{{ bump.start_time }}', '{{ bump.end_time }}')">
                            {{ bump.id }}
                        </a>
                    </td>
                    <td>{{ bump.start_time }}</td>
                    <td>{{ bump.end_time }}</td>
                    <td>
                        <button onclick="deleteBump({{ bump.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4">No bumps recorded.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Load latest Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let chartData;
        try {
            chartData = JSON.parse(`{{ chart_data|escapejs }}`);
            console.log("üìå Chart Data Loaded:", chartData);
        } catch (error) {
            console.error("‚ùå Error parsing chart data:", error);
            return;
        }

        if (!chartData || chartData.length === 0) {
            console.error("‚ùå No data available for plotting.");
            return;
        }

        // ‚úÖ Convert timestamps to UTC format
        let pvTrace = {
            x: chartData.map(row => new Date(row.Time)),  // Ensure it's treated as a Date object
            y: chartData.map(row => row.PV),
            name: "PV Trend",
            mode: "lines",
            line: { color: "#6B8E23", width: 2 }
        };

        let cvTrace = {
            x: chartData.map(row => new Date(row.Time)),
            y: chartData.map(row => row.CV),
            name: "CV Trend",
            mode: "lines",
            line: { color: "black", width: 2, dash: "solid" }
        };

        // ‚úÖ Generate bump highlight boxes with light transparent grayish-green color
        let bumpBoxes = [];
        let minY = Math.min(...chartData.map(row => row.PV), ...chartData.map(row => row.CV)); // Lowest value on chart
        let maxY = Math.max(...chartData.map(row => row.PV), ...chartData.map(row => row.CV)); // Highest value on chart

        {% for bump in bump_tests %}
            bumpBoxes.push({
                type: "rect",
                x0: new Date("{{ bump.start_time }}"),
                x1: new Date("{{ bump.end_time }}"),
                y0: minY,  // Full height
                y1: maxY,
                fillcolor: "rgba(143, 188, 143, 0.3)",  // Light Grayish-Green (RGBA: Sage Green)
                line: {
                    color: "rgba(60, 100, 60, 0.8)",  // Dark green for contrast
                    width: 1.5,
                    dash: "dash"  // Dashed border
                },
                opacity: 0.4
            });
        {% endfor %}

        let layout = {
            title: "Process Variable (PV) & Control Variable (CV)",
            xaxis: {
                title: "Time",
                type: "date",
            },
            yaxis: { title: "Value" },
            showlegend: true,
            hovermode: "closest",
            shapes: bumpBoxes  // ‚úÖ Adds bump boxes with dashed borders
        };

        let plotDiv = document.getElementById("identityTrendChart");
        console.log("üìå Plotting chart...");
        Plotly.newPlot(plotDiv, [pvTrace, cvTrace], layout);
    });

    function zoomToBump(bumpId, startTime, endTime) {
        console.log(`üìå Zooming to Bump ${bumpId} from ${startTime} to ${endTime}`);

        let plotDiv = document.getElementById("identityTrendChart");
        if (!plotDiv) {
            console.error("‚ùå Chart element not found.");
            return;
        }

        let localStart = new Date(startTime);
        let localEnd = new Date(endTime);

        console.log(`üìå Adjusted Zoom Range (UTC): ${localStart} to ${localEnd}`);

        Plotly.relayout(plotDiv, {
            "xaxis.range": [localStart, localEnd]
        });

        console.log(`‚úÖ Zoomed to Bump ${bumpId} successfully.`);
    }

    document.getElementById("saveBump").addEventListener("click", function () {
        console.log("üìå Saving new bump...");

        let plotDiv = document.getElementById("identityTrendChart");
        let zoomRange = plotDiv.layout.xaxis.range;
        if (!zoomRange || zoomRange.length < 2) {
            console.error("‚ùå Invalid zoom range detected:", zoomRange);
            alert("Please zoom into a valid time range before saving.");
            return;
        }

        let formattedStart = new Date(zoomRange[0]).toISOString();
        let formattedEnd = new Date(zoomRange[1]).toISOString();

        fetch("{% url 'save_bump' chart_id=trend_chart.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                trend_chart_id: "{{ trend_chart.id }}",
                bump_start: formattedStart,
                bump_end: formattedEnd
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("‚úÖ Bump saved successfully:", data);
                alert("Bump saved successfully!");
                location.reload();
            } else {
                console.error("‚ùå Error saving bump:", data.error);
                alert("Error saving bump: " + data.error);
            }
        })
        .catch(error => {
            console.error("‚ùå Request failed:", error);
            alert("Failed to save bump.");
        });
    });

    function deleteBump(bumpId) {
        if (!confirm("Are you sure you want to delete this bump test?")) {
            return;
        }

        console.log(`üìå Deleting bump ${bumpId}...`);

        fetch("{% url 'delete_bump' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                bump_id: bumpId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ Bump ${bumpId} deleted successfully.`);
                alert("Bump deleted successfully!");
                document.getElementById(`bumpRow-${bumpId}`).remove();
            } else {
                console.error("‚ùå Error deleting bump:", data.error);
                alert("Error deleting bump: " + data.error);
            }
        })
        .catch(error => {
            console.error("‚ùå Request failed:", error);
            alert("Failed to delete bump.");
        });
    }
</script>


{% endblock %}
