{% extends "base.html" %}

{% block content %}
<h2>Select Bump Test for {{ trend_chart.pid_loop.name }}</h2>

<!-- Embed the interactive Plotly chart -->
<div id="trendChart"></div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<script>
let xStart = null;
let xEnd = null;
const trendChartId = "{{ trend_chart.id }}";

// ‚úÖ Capture zoom range when user zooms in
document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Chart container found:", document.getElementById("trendChart"));

    try {
        let chartData;
        try {
            chartData = JSON.parse(`{{ chart_data|escapejs }}`);
        } catch (error) {
            console.error("‚ùå Chart Data Parsing Failed:", error);
            chartData = [];
        }
        console.log("üìå Chart Data:", chartData);

        if (!chartData || chartData.length === 0) {
            console.warn("‚ö†Ô∏è No chart data found.");
            return;
        }

        let traces = [
            { x: chartData.map(row => row.Time), y: chartData.map(row => row["PV"] || 0), name: "PV", mode: "lines" },
            { x: chartData.map(row => row.Time), y: chartData.map(row => row["CV"] || 0), name: "CV", mode: "lines" }
        ];

        let bumpTests = JSON.parse(`{{ bump_tests|escapejs }}`);  // ‚úÖ Get bump test times
        console.log("üìå Bump Tests:", bumpTests);

        let bumpBoxes = bumpTests.map(bump => ({
            type: "rect",
            xref: "x",  // Tie the box to the time (x-axis)
            yref: "paper",  // Full height (paper means % of chart height)
            x0: bump.start_time,  // Start of bump
            x1: bump.end_time,  // End of bump
            y0: 0,  // Start at bottom
            y1: 1,  // Extend to top
            line: { color: "red", width: 1, dash: "dashdot" },  // ‚úÖ Dashed red border
            fillcolor: "rgba(255, 0, 0, 0.1)",  // ‚úÖ Light transparent red fill
            layer: "below"  // Ensure it doesn't cover the trend
        }));

        let layout = {
            title: "{{ pid_name }} Trend",
            xaxis: { title: "Time", type: "date", tickformat: "%H:%M:%S" },
            yaxis: { title: "Values" },
            shapes: bumpBoxes  // ‚úÖ Add bump boxes to the layout
        };

        Plotly.newPlot("trendChart", traces, layout);
        console.log("‚úÖ Plotly chart rendering...");

        // ‚úÖ Capture zoom events
        document.getElementById("trendChart").on('plotly_relayout', function (eventData) {
            if (eventData["xaxis.range[0]"] && eventData["xaxis.range[1]"]) {
                xStart = eventData["xaxis.range[0]"];
                xEnd = eventData["xaxis.range[1]"];
                console.log("üìå Updated bump range:", xStart, xEnd);
            }
        });
    } catch (error) {
        console.error("‚ùå Chart Data Parsing Error:", error);
    }
});

// ‚úÖ Save Bump Test
function saveBump() {
    if (!xStart || !xEnd) {
        console.error("‚ùå No x-axis range detected.");
        alert("‚ùå Please zoom into a region before saving the bump test.");
        return;
    }

    const bumpData = { trend_chart_id: trendChartId, bump_start: xStart, bump_end: xEnd };

    console.log("üìå Sending bump test data:", bumpData);

    fetch(`/save-bump/${trendChartId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(bumpData)
    })
    .then(response => response.json())
    .then(data => {
        console.log("üìå Server Response:", data);
        if (data.success) {
            console.log("‚úÖ Bump test saved successfully.");
            alert("‚úÖ Bump test saved successfully.");
            location.reload();
        } else {
            console.error("‚ùå Error saving bump:", data.error);
            alert("‚ùå Error: " + data.error);
        }
    })
    .catch(error => {
        console.error("‚ùå Network error:", error);
        alert("‚ùå Network error. Check the console for details.");
    });
}

// ‚úÖ CSRF Token Retrieval
function getCSRFToken() {
    let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    if (!csrfToken) {
        csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }
    return csrfToken;
}

// ‚úÖ Zoom to Bump
function zoomToBump(startTime, endTime) {
    console.log("üìå Zooming to bump:", startTime, endTime);
    if (!startTime || !endTime) {
        console.error("‚ùå Invalid bump test time range.");
        alert("‚ùå Invalid bump test time range.");
        return;
    }

    let startISO = new Date(startTime.replace(" ", "T")).toLocaleString("sv-SE");
    let endISO = new Date(endTime.replace(" ", "T")).toLocaleString("sv-SE");

    console.log("‚úÖ ISO Converted:", startISO, endISO);
    Plotly.relayout('trendChart', { 'xaxis.range': [startISO, endISO] });
}
console.log("üìå Bump Tests Data from Django:", bumpTests);

</script>

<button id="submitBump" class="btn btn-primary" onclick="saveBump()">Save Selected Bump</button>

<h3>Bump Tests</h3>
<ul id="bumpTestList">
    <li>Loading bump tests...</li>
</ul>

<script>
    function renderBumpTests() {
    let bumpTests = JSON.parse(`{{ bump_tests|escapejs }}`);
    let bumpList = document.getElementById("bumpTestList");

    // Clear existing content
    bumpList.innerHTML = "";

    if (bumpTests.length === 0) {
        bumpList.innerHTML = "<li>No bump tests available.</li>";
        return;
    }

    bumpTests.forEach((bump) => {
        let listItem = document.createElement("li");

        // Create Zoom to Bump link
        let bumpLink = document.createElement("a");
        bumpLink.href = "#";
        bumpLink.textContent = `Zoom to Bump (${bump.start_time} - ${bump.end_time})`;
        bumpLink.onclick = function () {
            zoomToBump(bump.start_time, bump.end_time);
        };

        // Create Delete button
        let deleteButton = document.createElement("button");
        deleteButton.textContent = "‚ùå Delete";
        deleteButton.style.marginLeft = "10px";
        deleteButton.onclick = function () {
            deleteBumpTest(bump.id);  // Send only the ID
        };

        // Append elements
        listItem.appendChild(bumpLink);
        listItem.appendChild(deleteButton);
        bumpList.appendChild(listItem);
    });
}

    function deleteBumpTest(bumpId) {
    if (!confirm(`Are you sure you want to delete this bump test?`)) {
        return;
    }

    fetch(`/delete-bump/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({ bump_id: bumpId }),  // Sending ID instead of timestamps
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Bump test deleted!");
            renderBumpTests(); // Refresh the bump list
            location.reload(); // Reload to remove the bump box on the chart
        } else {
            alert("Error deleting bump test: " + data.error);
        }
    })
    .catch(error => console.error("Error:", error));
}

    // Function to get CSRF token for POST requests
    function getCSRFToken() {
        return document.cookie.split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
    }

    document.addEventListener("DOMContentLoaded", renderBumpTests);
</script>

{% endblock %}
