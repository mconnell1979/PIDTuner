{% extends "base.html" %}

{% block content %}
    <h1>Trend Chart Detail</h1>
    <div id="identityTrendChart" style="width: 100%; height: 500px;"></div>
    <button id="saveBump" style="margin-top: 10px;">Save Bump</button>

    <!-- Display all bump tests -->
    <h2>Bump Tests</h2>
    <table border="1" style="width: 100%; margin-top: 20px; text-align: center;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="bumpList">
            {% if bump_tests %}
                {% for bump in bump_tests %}
                <tr id="bumpRow-{{ bump.id }}">
                    <td>
                        <a href="#" onclick="zoomToBump({{ bump.id }}, '{{ bump.start_time|date:'c' }}', '{{ bump.end_time|date:'c' }}')">
                            {{ bump.id }}
                        </a>
                    </td>
                    <td>{{ bump.start_time|date:"Y-m-d H:i:s \U\T\C" }}</td>
                    <td>{{ bump.end_time|date:"Y-m-d H:i:s \U\T\C" }}</td>
                    <td>
                        <button onclick="deleteBump({{ bump.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4">No bumps recorded.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Load latest Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

    <!-- js logic -->
    <script>

        function deleteBump(bumpId) {
            if (!confirm("Are you sure you want to delete this bump test?")) {
                return;
            }

            console.log("üìå Deleting Bump Test ID:", bumpId);

            fetch(`/delete-bump/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ bump_id: bumpId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ Bump test deleted successfully!");
                    document.getElementById(`bumpRow-${bumpId}`).remove();
                } else {
                    alert("‚ùå Error: " + data.error);
                }
            })
            .catch(error => {
                console.error("‚ùå Error deleting bump test:", error);
                alert("‚ùå Failed to delete bump test.");
            });
        }

        function getCSRFToken() {
            let csrfToken = document.cookie.split('; ')
                .find(row => row.startsWith('csrftoken'))
                ?.split('=')[1];
            if (!csrfToken) {
                console.warn("‚ö†Ô∏è CSRF token not found.");
            }
            return csrfToken;
        }

        function zoomToBump(bumpId, startTime, endTime) {
            console.log(`üìå Zooming to Bump Test ID: ${bumpId}, Start: ${startTime}, End: ${endTime}`);
            Plotly.relayout("identityTrendChart", {
                "xaxis.range": [startTime, endTime]
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            let trendChartId = "{{ trend_chart.id }}";
            let currentXRange = null;
            let plotDiv = document.getElementById("identityTrendChart");

            try {
                chartData = JSON.parse(`{{ chart_data|escapejs }}`);
                console.log("üìå Chart Data Loaded:", chartData);
            } catch (error) {
                console.error("‚ùå Error parsing chart data:", error);
                return;
            }
            if (!chartData || chartData.length === 0) {
                console.error("‚ùå No data available for plotting.");
                return;
            }

            console.log("üìå First 5 Chart Data Points for Plotly:", chartData.slice(0, 5));

            let pvTrace = {
                x: chartData.map(row => new Date(row.Time)),
                y: chartData.map(row => parseFloat(row.PV) || 0),
                name: "PV Trend",
                mode: "lines",
                line: { color: "#6B8E23", width: 2 }
            };

            let cvTrace = {
                x: chartData.map(row => new Date(row.Time)),
                y: chartData.map(row => parseFloat(row.CV) || 0),
                name: "CV Trend",
                mode: "lines",
                line: { color: "black", width: 2, dash: "solid" }
            };

            let bumpBoxes = [];
            let minY = Math.min(...chartData.map(row => row.PV), ...chartData.map(row => row.CV));
            let maxY = Math.max(...chartData.map(row => row.PV), ...chartData.map(row => row.CV));

            {% for bump in bump_tests %}
                {
                    let bumpStart = new Date("{{ bump.start_time|date:'c' }}");
                    let bumpEnd = new Date("{{ bump.end_time|date:'c' }}");
                    console.log("üìå Highlighting Bump Test (UTC): Start =", bumpStart.toISOString(), ", End =", bumpEnd.toISOString());
                    bumpBoxes.push({
                        type: "rect",
                        x0: bumpStart.toISOString(),
                        x1: bumpEnd.toISOString(),
                        y0: minY,
                        y1: maxY,
                        fillcolor: "rgba(143, 188, 143, 0.3)",
                        line: { color: "rgba(60, 100, 60, 0.8)", width: 1.5, dash: "dash" },
                        opacity: 0.4
                    });
                }
            {% endfor %}

            let plotLayout = {
                title: "{{ trend_chart.pid_loop.name }} - Trend ID {{ trend_chart.id }} - {{ trend_chart.description }}",
                xaxis: {
                    title: "Time (UTC)",
                    type: "date",
                    tickformat: "%Y-%m-%d %H:%M:%S UTC",
                    tickmode: "auto",
                    automargin: true,
                    ticklabelmode: "instant"
                },
                yaxis: { title: "Value" },
                showlegend: true,
                hovermode: "closest",
                shapes: bumpBoxes
            };

            console.log("üìå Plotting chart...");
            Plotly.newPlot(plotDiv, [pvTrace, cvTrace], plotLayout).then(function() {
                console.log("üìå Chart is now fully rendered.");
                plotDiv.on("plotly_relayout", function(eventData) {
                    console.log("üìå Relayout Event Data:", eventData);
                    if (eventData["xaxis.range"]) {
                        currentXRange = eventData["xaxis.range"];
                        console.log("üìå Zoomed-in Time Range Captured:", currentXRange);
                    } else if (eventData["xaxis.range[0]"] && eventData["xaxis.range[1]"]) {
                        currentXRange = [
                            eventData["xaxis.range[0]"],
                            eventData["xaxis.range[1]"]
                        ];
                        console.log("üìå Zoomed-in Time Range (Alternative):", currentXRange);
                    } else {
                        console.log("‚ö†Ô∏è No zoom range detected.");
                    }
                });
            });

            document.getElementById("saveBump").addEventListener("click", function () {
                if (!currentXRange || currentXRange.length !== 2) {
                    alert("‚ö†Ô∏è Please zoom into a range before saving a bump test.");
                    return;
                }
                let start_time = currentXRange[0];
                let end_time = currentXRange[1];
                console.log(`üìå Saving Bump Test: Start - ${start_time}, End - ${end_time}`);
                fetch(`/save-bump/${trendChartId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({ bump_start: start_time, bump_end: end_time })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("‚úÖ Bump test saved successfully!");
                        location.reload();
                    } else {
                        alert("‚ùå Error: " + data.error);
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error saving bump test:", error);
                    alert("‚ùå Failed to save bump test.");
                });
            });
        });
</script>











{% endblock %}
