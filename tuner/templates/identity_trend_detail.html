{% extends "base.html" %}

{% block content %}

<div class="container">
    <h1>Identity Trend for {{ trend_chart.pid_loop.name }}</h1>
    <h2>Bump Test: {{ bump_test.start_time }} to {{ bump_test.end_time }}</h2>

    <label for="T1">T1:</label>
    <input type="text" id="T1" name="T1" value="{{ bump_test.T1|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T2">T2:</label>
    <input type="text" id="T2" name="T2" value="{{ bump_test.T2|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T3">T3:</label>
    <input type="text" id="T3" name="T3" value="{{ bump_test.T3|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T4">T4:</label>
    <input type="text" id="T4" name="T4" value="{{ bump_test.T4|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <button id="saveT1T2">Save T1, T2, T3, T4</button>

    <div id="identityTrendChart"></div>
</div>

<!-- JavaScript to Display Annotations -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("üìå Initializing Trend Chart...");

        // ‚úÖ Convert bump test times to UTC
        let bumpTestStart = new Date("{{ bump_test.start_time|date:'c' }}").toISOString();
        let bumpTestEnd = new Date("{{ bump_test.end_time|date:'c' }}").toISOString();

        console.log("üìå Bump Window Start (Forced UTC):", bumpTestStart);
        console.log("üìå Bump Window End (Forced UTC):", bumpTestEnd);

        let chartData;
        try {
            chartData = JSON.parse(`{{ chart_data|escapejs }}`);
            console.log("üìå Loaded Chart Data:", chartData);
        } catch (error) {
            console.error("‚ùå Error parsing chart data:", error);
            return;
        }

        let tMarkers;
        try {
            tMarkers = JSON.parse(`{{ t_markers|escapejs }}`);
            console.log("üìå Raw tMarkers JSON:", tMarkers);
        } catch (error) {
            console.error("‚ùå Error parsing T1-T4 markers:", error);
            return;
        }

        if (!Array.isArray(chartData) || chartData.length === 0) {
            console.error("‚ùå No data available for plotting.");
            return;
        }

        function drawChart(data) {
            // ‚úÖ Convert all timestamps in data to UTC format
            let parsedData = data.map(d => ({
                x: new Date(d.Time).toISOString(),  // Convert to UTC
                PV: parseFloat(d.PV),
                CV: parseFloat(d.CV)
            }));

            console.log("üìå Data Sent to Plotly:", parsedData);
            console.log("üìå First Timestamp in Data:", parsedData[0].x);
            console.log("üìå Last Timestamp in Data:", parsedData[parsedData.length - 1].x);

            let pvTrace = {
                x: parsedData.map(d => d.x),
                y: parsedData.map(d => d.PV),
                name: "PV Trend",
                mode: "lines",
                line: { color: "#6B8E23", width: 2 }
            };

            let cvTrace = {
                x: parsedData.map(d => d.x),
                y: parsedData.map(d => d.CV),
                name: "CV Trend",
                mode: "lines",
                line: { color: "black", width: 2, dash: "solid" }
            };

            let layout = {
                title: "{{ trend_chart.pid_loop.name }} - Bump {{ bump_test.id }}",
                xaxis: {
                    title: "Time",
                    type: "date",
                    range: [bumpTestStart, bumpTestEnd],  // ‚úÖ Ensure proper range
                    showgrid: true,
                },
                yaxis: { title: "Value" },
                hovermode: "closest"
            };

            Plotly.newPlot("identityTrendChart", [pvTrace, cvTrace], layout);
        }

        function zoomToBump(startTime, endTime) {
            console.log(`üìå Raw Zoom to Bump Window: ${startTime} ‚Üí ${endTime}`);

            // ‚úÖ Explicitly parse as UTC and prevent local conversion
            let utcStartTime = new Date(startTime).toISOString();
            let utcEndTime = new Date(endTime).toISOString();

            console.log(`üìå Converted to UTC: ${utcStartTime} ‚Üí ${utcEndTime}`);

            if (document.getElementById("identityTrendChart")) {
                Plotly.relayout("identityTrendChart", {
                    "xaxis.range": [utcStartTime, utcEndTime]
                });
            } else {
                console.error("‚ö†Ô∏è identityTrendChart not found! Ensure the chart is properly initialized.");
            }
        }

        drawChart(chartData);
        zoomToBump(bumpTestStart, bumpTestEnd);
    });
</script>




{% endblock %}
