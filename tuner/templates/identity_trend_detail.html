{% extends "base.html" %}

{% block content %}

<div class="container">
    <h1>Identity Trend for {{ trend_chart.pid_loop.name }}</h1>
    <h2>Bump Test: {{ bump_test.start_time }} to {{ bump_test.end_time }}</h2>

    <label for="T1">T1:</label>
    <input type="text" id="T1" name="T1" value="{{ bump_test.T1|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T2">T2:</label>
    <input type="text" id="T2" name="T2" value="{{ bump_test.T2|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T3">T3:</label>
    <input type="text" id="T3" name="T3" value="{{ bump_test.T3|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <label for="T4">T4:</label>
    <input type="text" id="T4" name="T4" value="{{ bump_test.T4|date:'Y-m-d H:i:s'|default:'' }}" readonly>

    <button id="saveT1T2">Save T1, T2, T3, T4</button>

    <div id="identityTrendChart"></div>
</div>

<!-- JavaScript to Display Annotations -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("üìå Initializing Trend Chart...");

        let bumpTestStart = new Date("{{ bump_test.start_time|date:'c' }}").toISOString();
        let bumpTestEnd = new Date("{{ bump_test.end_time|date:'c' }}").toISOString();

        console.log("üìå Bump Window Start (Forced UTC):", bumpTestStart);
        console.log("üìå Bump Window End (Forced UTC):", bumpTestEnd);

        let chartData, tMarkers;
        try {
            chartData = JSON.parse(`{{ chart_data|escapejs }}`);
            tMarkers = JSON.parse(`{{ t_markers|escapejs }}`);
            console.log("üìå Loaded Chart Data:", chartData);
            console.log("üìå Raw tMarkers JSON:", tMarkers);
        } catch (error) {
            console.error("‚ùå Error parsing chart or marker data:", error);
            return;
        }

        function drawChart(data) {
            let parsedData = data.map(d => ({
                x: d.Time,
                PV: parseFloat(d.PV),
                CV: parseFloat(d.CV)
            }));

            let pvTrace = {
                x: parsedData.map(d => d.x),
                y: parsedData.map(d => d.PV),
                name: "PV Trend",
                mode: "lines",
                line: { color: "#6B8E23", width: 2 }
            };

            let cvTrace = {
                x: parsedData.map(d => d.x),
                y: parsedData.map(d => d.CV),
                name: "CV Trend",
                mode: "lines",
                line: { color: "black", width: 2, dash: "solid" }
            };

            function getPVAtTime(time) {
                let point = parsedData.find(d => d.x.startsWith(time.substring(0, 19)));
                return point ? point.PV : null;
            }

            let markerColors = ["#D3D3D3", "#A9A9A9", "#808080", "#505050"];
            let markers = [
                { time: tMarkers.T1.time, pv: getPVAtTime(tMarkers.T1.time), name: "T1", color: markerColors[0] },
                { time: tMarkers.T2.time, pv: getPVAtTime(tMarkers.T2.time), name: "T2", color: markerColors[1] },
                { time: tMarkers.T3.time, pv: getPVAtTime(tMarkers.T3.time), name: "T3", color: markerColors[2] },
                { time: tMarkers.T4.time, pv: getPVAtTime(tMarkers.T4.time), name: "T4", color: markerColors[3] }
            ].filter(m => m.pv !== null);

            let markerTraces = markers.map(m => ({
                x: [m.time],
                y: [m.pv],
                name: m.name,
                mode: "markers",
                marker: { color: m.color, size: 10 }
            }));

            let layout = {
                title: "{{ trend_chart.pid_loop.name }} - Bump {{ bump_test.id }}",
                xaxis: { title: "Time", type: "date", range: [bumpTestStart, bumpTestEnd], showgrid: true },
                yaxis: { title: "Value" },
                hovermode: "closest"
            };

            Plotly.newPlot("identityTrendChart", [pvTrace, cvTrace, ...markerTraces], layout).then(function (chart) {
                chart.on('plotly_click', function (data) {
                    if (!selectedField) {
                        console.log("‚ö†Ô∏è No field selected. Click on a T1-T4 input first.");
                        return;
                    }
                    let clickedTime = data.points[0].x;
                    console.log(`üìå Setting ${selectedField} = ${clickedTime}`);
                    document.getElementById(selectedField).value = clickedTime;
                });
            });
        }

        let selectedField = null;
        ["T1", "T2", "T3", "T4"].forEach(field => {
            document.getElementById(field).addEventListener("focus", function () {
                selectedField = field;
                console.log("üìå Selected Field:", selectedField);
            });
        });

        drawChart(chartData);

        document.getElementById("saveT1T2").addEventListener("click", function () {
            function toUTCStringWithOffset(dateStr) {
                if (!dateStr) return null;
                let dt = new Date(dateStr);
                let offsetMinutes = dt.getTimezoneOffset();
                let offsetHours = offsetMinutes / 60;

                console.log(`üìå Browser Time Offset: ${offsetHours} hours`);

                dt.setHours(dt.getHours() - offsetHours);  // ‚úÖ Subtract instead of adding
                return dt.toISOString();
            }

            let t1 = toUTCStringWithOffset(document.getElementById("T1").value);
            let t2 = toUTCStringWithOffset(document.getElementById("T2").value);
            let t3 = toUTCStringWithOffset(document.getElementById("T3").value);
            let t4 = toUTCStringWithOffset(document.getElementById("T4").value);

            console.log("üìå Sending T1-T4 to server (Adjusted for Browser Offset):", { T1: t1, T2: t2, T3: t3, T4: t4 });

            fetch(`/update_t1_t2/{{ bump_test.id }}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ T1: t1, T2: t2, T3: t3, T4: t4 }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("‚úÖ Times saved successfully!");
                    alert("Times saved successfully!");
                    location.reload();
                } else {
                    console.error("‚ùå Save failed:", data.error);
                    alert("Error saving times: " + data.error);
                }
            })
            .catch(error => console.error("‚ùå Request failed:", error));
        });

        // ‚úÖ Fix: Add missing CSRF helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>


{% endblock %}
